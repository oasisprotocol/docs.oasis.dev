"use strict";(self.webpackChunkdocs_oasis_io=self.webpackChunkdocs_oasis_io||[]).push([[22],{1003:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"build/sapphire/develop/security","title":"Security","description":"Recipes for Confidentiality: Security considerations when writing confidential contracts","source":"@site/docs/build/sapphire/develop/security.md","sourceDirName":"build/sapphire/develop","slug":"/build/sapphire/develop/security","permalink":"/build/sapphire/develop/security","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/sapphire-paratime/edit/main/docs/develop/security.md","tags":[],"version":"current","lastUpdatedAt":1740673730000,"frontMatter":{"description":"Recipes for Confidentiality: Security considerations when writing confidential contracts"},"sidebar":"developers","previous":{"title":"Deployment Patterns","permalink":"/build/sapphire/develop/deployment"},"next":{"title":"Testing","permalink":"/build/sapphire/develop/testing"}}');var a=t(4848),s=t(8453),o=t(5537),i=t(9329);const l={description:"Recipes for Confidentiality: Security considerations when writing confidential contracts"},c="Security",d={},u=[{value:"Storage Access Patterns",id:"storage-access-patterns",level:2},{value:"Order of Operations",id:"order-of-operations",level:2},{value:"Speed Bump",id:"speed-bump",level:2},{value:"Gas Padding",id:"gas-padding",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"security",children:"Security"})}),"\n",(0,a.jsx)(n.p,{children:"This page is an ongoing work in progress to support confidential smart contract\ndevelopment. At the moment we address safeguarding storage variable access\npatterns and provide best practices for more secure orderings of error checking\nto prevent leaking contract state."}),"\n",(0,a.jsx)(n.h2,{id:"storage-access-patterns",children:"Storage Access Patterns"}),"\n",(0,a.jsxs)(n.p,{children:["You can use a tool such as ",(0,a.jsx)(n.a,{href:"https://www.npmjs.com/package/hardhat-tracer",children:"hardhat-tracer"})," to examine the base EVM state\ntransitions under the hood."]}),"\n",(0,a.jsxs)(o.A,{groupId:"npm2yarn",children:[(0,a.jsx)(i.A,{value:"npm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npm install -D hardhat-tracer\n"})})}),(0,a.jsx)(i.A,{value:"pnpm",label:"pnpm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"pnpm add -D hardhat-tracer\n"})})}),(0,a.jsx)(i.A,{value:"yarn",label:"Yarn",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"yarn add --dev hardhat-tracer\n"})})})]}),"\n",(0,a.jsxs)(n.p,{children:["and add ",(0,a.jsx)(n.code,{children:"hardhat-tracer"})," to your ",(0,a.jsx)(n.code,{children:"config.ts"})," file,"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'import "hardhat-tracer"\n'})}),"\n",(0,a.jsx)(n.p,{children:"in order to test and show call traces."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat test --vvv --opcodes SSTORE,SLOAD\n"})}),"\n",(0,a.jsx)(n.p,{children:"You can also trace a particular transaction, once you know its hash."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat trace --hash 0xTransactionHash\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For both ",(0,a.jsx)(n.a,{href:"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html",children:"gas"})," usage and confidentiality purposes, we ",(0,a.jsx)(n.strong,{children:"recommend using\nnon-unique data size"}),". E.g. 64-byte value will still be distinct from a\n128-byte value."]}),"\n",(0,a.jsx)(n.admonition,{title:"Inference based on access patterns",type:"caution",children:(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"SSTORE"})," keys from one transaction may be linked to ",(0,a.jsx)(n.code,{children:"SLOAD"})," keys of another\ntransaction."]})}),"\n",(0,a.jsx)(n.h2,{id:"order-of-operations",children:"Order of Operations"}),"\n",(0,a.jsxs)(n.p,{children:["When handling errors, gas usage patterns not only can reveal the code path\ntaken, ",(0,a.jsx)(n.strong,{children:"but sometimes the balance of a user as well"})," (in the case of a diligent\nattacker using binary search)."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-solidity",children:"function transferFrom(address who, address to, uint amount)\n  external\n{\n  require( balances[who] >= amount );\n  require( allowances[who][msg.sender] >= amount );\n  // ...\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Modifying the order of error checking can prevent the accidental disclosure of\nbalance information in the example above."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-solidity",children:"function transferFrom(address who, address to, uint amount)\n  external\n{\n  require( allowances[who][msg.sender] >= amount );\n  require( balances[who] >= amount );\n  // ...\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"speed-bump",children:"Speed Bump"}),"\n",(0,a.jsx)(n.p,{children:"If we would like to prevent off-chain calls from being chained together, we can\nensure that the block has been finalized."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-solidity",children:'contract Secret {\n  uint256 private _height;\n  bytes private _secret;\n  address private _buyer;\n\n  constructor(bytes memory _text) {\n    _secret = _text;\n  }\n\n  function recordPayment() external payable {\n    require(msg.value == 1 ether);\n    // set and lock buyer\n    _height = block.number;\n    _buyer = msg.sender;\n  }\n\n  /// @notice Reveals the secret.\n  function revealSecret() view external returns (bytes memory) {\n    require(block.number > _height, "not settled");\n    require(_buyer != address(0), "no recorded buyer");\n    // TODO: optionally authenticate call from buyer\n    return _secret;\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"gas-padding",children:"Gas Padding"}),"\n",(0,a.jsxs)(n.p,{children:["To prevent leaking information about a particular transaction, Sapphire\nprovides a ",(0,a.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#padgas",children:"precompile"})," for dApp developers to ",(0,a.jsx)(n.strong,{children:"pad the amount of gas used\nin a transaction"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-solidity",children:"contract GasExample {\n  bytes32 tmp;\n\n  function constantMath(bool doMath, uint128 padGasAmount) external {\n    if (doMath) {\n      bytes32 x;\n\n      for (uint256 i = 0; i < 100; i++) {\n        x = keccak256(abi.encodePacked(x, tmp));\n      }\n\n      tmp = x;\n    }\n\n    Sapphire.padGas(padGasAmount);\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Both contract calls below should use the same amount of gas. Sapphire also\nprovides the precompile to return the gas ",(0,a.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#gasused",children:"used"})," by the current transaction."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"await contract.constantMath(true, 100000);\nawait contract.constantMath(false, 100000);\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},9329:(e,n,t)=>{t.d(n,{A:()=>o});t(6540);var r=t(4164);const a={tabItem:"tabItem_Ymn6"};var s=t(4848);function o(e){let{children:n,hidden:t,className:o}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(a.tabItem,o),hidden:t,children:n})}},5537:(e,n,t)=>{t.d(n,{A:()=>w});var r=t(6540),a=t(4164),s=t(5627),o=t(6347),i=t(372),l=t(604),c=t(1861),d=t(8749);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:t,attributes:r,default:a}}=e;return{value:n,label:t,attributes:r,default:a}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:t}=e;const a=(0,o.W6)(),s=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,l.aZ)(s),(0,r.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(a.location.search);n.set(s,e),a.replace({...a.location,search:n.toString()})}),[s,a])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,s=h(e),[o,l]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const r=t.find((e=>e.default))??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:s}))),[c,u]=m({queryString:t,groupId:a}),[f,b]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,s]=(0,d.Dv)(t);return[a,(0,r.useCallback)((e=>{t&&s.set(e)}),[t,s])]}({groupId:a}),g=(()=>{const e=c??f;return p({value:e,tabValues:s})?e:null})();(0,i.A)((()=>{g&&l(g)}),[g]);return{selectedValue:o,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),b(e)}),[u,b,s]),tabValues:s}}var b=t(9136);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(4848);function v(e){let{className:n,block:t,selectedValue:r,selectValue:o,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),d=e=>{const n=e.currentTarget,t=l.indexOf(n),a=i[t].value;a!==r&&(c(n),o(a))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;n=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;n=l[t]??l[l.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},n),children:i.map((e=>{let{value:n,label:t,attributes:s}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:e=>{l.push(e)},onKeyDown:u,onClick:d,...s,className:(0,a.A)("tabs__item",g.tabItem,s?.className,{"tabs__item--active":r===n}),children:t??n},n)}))})}function y(e){let{lazy:n,children:t,selectedValue:s}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===s));return e?(0,r.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==s})))})}function j(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,a.A)("tabs-container",g.tabList),children:[(0,x.jsx)(v,{...n,...e}),(0,x.jsx)(y,{...n,...e})]})}function w(e){const n=(0,b.A)();return(0,x.jsx)(j,{...e,children:u(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var r=t(6540);const a={},s=r.createContext(a);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);