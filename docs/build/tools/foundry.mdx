---
description: A guide for Foundry
---

# Foundry

[Foundry] is a smart contract development environment
for EVM-based chains. This guide will show you how to use Foundry to build,
test, and deploy smart contracts on Oasis Sapphire.

:::info

For comprehensive details about Foundry's features, consult the
[Foundry documentation].

:::

Foundry contains the following tools:

- **Forge** is a CLI [tool] for building, testing,
and deploying smart contracts.
Due to integrated revm it significantly increases runtime speed when testing.

- **Anvil** is a local development EVM [node].
It is installed as part of Foundry, but currently cannot
be extended with Sapphire features.

- **Cast** is a [CLI tool] for interacting with EVM nodes.
It uses RPC calls, so it can be used
to interact with Sapphire nodes running the [Oasis Web3 gateway].

- **Chisel** is a Solidity [REPL] (short for "read-eval-print loop")
that allows developers to write and test Solidity code snippets.
It provides an interactive environment for writing and executing
Solidity code, as well as a set of built-in commands for working
with and debugging your code.


## Setup and Configuration

Foundry uses default revm EVM implementation which does not contain
[Sapphire-specific features].
For that reason, we have to install special Sapphire precompiles which are
available in the **Sapphire foundry** package.

**Sapphire Contracts** package is also provided. It contains
helper solidity contracts and libraries that enable convenient access to
on-chain data and precompiles (rng, signatures, on-chain encryption, etc.).

Follow the steps below to setup your project:

1. Install and run Foundryup:

   ```shell
   curl -L https://foundry.paradigm.xyz | bash
   foundryup
   source ~/.bashrc
   ```

2. Create a new Forge project and move inside:

   ```shell
   forge init sapphire_demo
   cd sapphire_demo
   ```

3. After intializing the project, we can install the **Sapphire Contracts**
package using Foundry package manager [soldeer]:

   ```shell
   forge soldeer install @oasisprotocol-sapphire-contracts~0.2.11
   ```

### Installing Sapphire Foundry (Optional)

If you intend to use Sapphire features in Forge tests,
follow these additional steps:

1. Install the **Sapphire Foundry** soldeer package:

   ```shell
   forge soldeer install @oasisprotocol-sapphire-foundry~0.1.0
   ```

2. Add `ffi = true` to your foundry.toml file:

3. Your foundry.toml file should now look like this:

   ```toml
   [profile.default]
   src = "src"
   out = "out"
   libs = ["lib", "dependencies"]
   ffi = true

   [dependencies]
   "@oasisprotocol-sapphire-contracts" = "0.2.11"
   "@oasisprotocol-sapphire-foundry" = "0.1.0"
   ```

   Note:
   - `ffi = true` enables `vm.ffi()` ([foreign function interface])
   which is used to call rust bindings containing the precompile and
   decryption logic
   - `"dependencies"` lists the required project dependencies installed
   via the Foundry package manager [soldeer]
   - (Alternative) You can also skip previous steps, copy the contents
   to your foundry.toml file and run:

   ```shell
   forge soldeer install
   ```

4. Install rust toolchain (nightly):

   ```shell
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   rustup toolchain install nightly
   rustup default nightly
   ```

   Note: `@oasisprotocol-sapphire-foundry` relies on Oasis Sapphire
   `runtime-sdk` crate which requires nightly toolchain.

5. Install Sapphire precompiles:
   ```shell
   cd dependencies/@oasisprotocol-sapphire-foundry-0.1.0/precompiles
   cargo +nightly build --release
   ```

## Sapphire specific features

Users who aren't familiar with confidential benefits of Sapphire
should take a moment to review the Ethereum [comparison page].
The `@oasisprotocol-sapphire-foundry` package enables
testing with precompiles and encrypted calls.

#### Precompiles

Sapphire precompiles are special precompiled contracts that
contain cryptographic primitives and enable confidential transactions.
Since Foundry uses un-customized revm, they are not available by default.

To enable them in Forge tests, add the **import** statement to your test file:

```solidity
import {SapphireTest} from "@oasisprotocol-sapphire-foundry-0.1.0/BaseSapphireTest.sol";
```
and then inherit from `SapphireTest` from `BaseSapphireTest.sol`
and override the `setUp()` function:
```solidity
   contract PrecompileTest is SapphireTest {
      
      function setUp() public override {
         super.setUp();
      }
```

#### Encrypted Transactions and Calls

Sapphire uses end-to-end encryption for confidential transactions and calls.
This means that the calldata is encrypted using the shared [key].
For non-encrypted transactions, the process works same as on Ethereum.
However, when testing for example [gasless transactions] with Foundry,
we need to add a few things.

After deploying the precompiles in the previous step, we need to
update our custom contract, encrypt the transaction and broadcast it.

1. `SapphireDecryptor` is a special contract that implements decryption
through the fallback function.
We need to inherit from it to enable decryption.

```solidity
   import {SapphireDecryptor} from "@oasisprotocol-sapphire-foundry-0.1.0/BinaryContracts.sol";

   contract CustomContract is SapphireDecryptor {
```

2. See [examples/foundry] for this step to see
how to test encrypted gasless transaction.

3. `vm.broadcastRawTransaction(raw_tx)` to send the raw transaction.


### Forge Tests

To run tests add a new file in the `tests/` directory. Run tests with:
```shell
forge test
```
:::info Example: Foundry  

Visit the Sapphire ParaTime repository to download the [Foundry][foundry-example]
example.  

:::  

[foundry-example]: https://github.com/oasisprotocol/sapphire-paratime/tree/main/examples/foundry

### Forge Script

To run a script add a new file in the `scripts/` directory. Run scripts with:

```shell
forge script
```

Forge scripts should run the same way as tests.

## A note on Forks/External RPC nodes

When running scripts, we might also want to run on Localnet/Testnet/Mainnet
using `--rpc-url` or `--fork-url`.
This is not possible with this setup, because Sapphire precompiles are not
available in the default revm.
When using `forge script` on an external RPC node or a fork,
precompiles are available through the `vm.rpcUrl()` cheatcode.
To disable simulation on integrated revm make sure to disable
simulation with `--no-simulation` flag and
remove the imports and inheritances from previous steps.

## Verification with Foundry

After contracts are deployed, you can verify them with Sourcify.
Check out the [verification with foundry] section for more details.

Should you have any questions, do not hesitate to share them with us on the
[#dev-central Discord channel][discord].

[Foundry]: https://github.com/foundry-rs/foundry
[Foundry documentation]: https://book.getfoundry.sh/
[discord]: https://oasis.io/discord
[tool]: https://book.getfoundry.sh/forge/
[node]: https://book.getfoundry.sh/anvil/
[CLI tool]: https://book.getfoundry.sh/cast/
[REPL]: https://book.getfoundry.sh/chisel/
[Sapphire-specific features]: ../sapphire/ethereum
[comparison page]: ../sapphire/ethereum
[gasless transactions]: ../sapphire/develop/gasless
[key]: ../sapphire/develop/concept
[examples/foundry]: https://github.com/oasisprotocol/sapphire-paratime/tree/main/examples/foundry
[verification with foundry]: ./verification/#verification-with-foundry
[foreign function interface]: https://book.getfoundry.sh/cheatcodes/ffi
[soldeer]: https://book.getfoundry.sh/projects/soldeer?highlight=soldeer#soldeer-as-a-package-manager
[Oasis Web3 gateway]: ../../node/web3.mdx
