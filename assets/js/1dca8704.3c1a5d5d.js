"use strict";(self.webpackChunkdocs_oasis_io=self.webpackChunkdocs_oasis_io||[]).push([[219],{2610:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>c,metadata:()=>o,toc:()=>h});const o=JSON.parse('{"id":"build/sapphire/develop/concept","title":"Concepts","description":"Sapphire concepts","source":"@site/docs/build/sapphire/develop/concept.mdx","sourceDirName":"build/sapphire/develop","slug":"/build/sapphire/develop/concept","permalink":"/build/sapphire/develop/concept","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/sapphire-paratime/edit/main/docs/develop/concept.mdx","tags":[],"version":"current","lastUpdatedAt":1740673730000,"frontMatter":{"description":"Sapphire concepts"},"sidebar":"developers","previous":{"title":"Develop on Sapphire","permalink":"/build/sapphire/develop/"},"next":{"title":"Browser Support","permalink":"/build/sapphire/develop/browser"}}');var s=n(4848),a=n(8453),r=n(4405),i=n(4117);const c={description:"Sapphire concepts"},l="Concepts",d={},h=[{value:"Transactions &amp; Calls",id:"transactions--calls",level:2},{value:"Contract State",id:"contract-state",level:2},{value:"Contract Logs",id:"contract-logs",level:2},{value:"See also",id:"see-also",level:2}];function p(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",strong:"strong",...(0,a.R)(),...e.components},{Details:o}=t;return o||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"concepts",children:"Concepts"})}),"\n",(0,s.jsx)(t.h2,{id:"transactions--calls",children:"Transactions & Calls"}),"\n","\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Client, Key Manager, Compute Node diagram",src:n(695).A+""})}),"\n",(0,s.jsxs)(t.p,{children:["The figure above illustrates the flow of a ",(0,s.jsx)(t.strong,{children:"confidential smart contract\ntransaction"})," on Sapphire."]}),"\n",(0,s.jsxs)(t.p,{children:["Transactions and calls must be encrypted and signed for maximum security.\nThe ",(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/@oasisprotocol/sapphire-paratime",children:"@oasisprotocol/sapphire-paratime"})," npm package will make your life\neasy. It'll handle cryptography and signing for you."]}),"\n",(0,s.jsxs)(t.p,{children:["You should be aware that taking actions based on the value of private data may\n",(0,s.jsx)(t.strong,{children:"leak the private data through side channels"})," like time spent, gas use and\naccessed memory locations. If you need to branch on private data, you should in\nmost cases ensure that both branches exhibit the same time/gas and storage\npatterns."]}),"\n",(0,s.jsxs)(t.p,{children:["You can also make ",(0,s.jsx)(t.strong,{children:"confidential smart contract calls"})," on Sapphire. If you\nuse ",(0,s.jsx)(t.code,{children:"msg.sender"})," for access control in your contract, the call ",(0,s.jsx)(t.strong,{children:"must be\nsigned"}),", otherwise ",(0,s.jsx)(t.code,{children:"msg.sender"})," will be zeroed. On the other hand, set the\n",(0,s.jsx)(t.code,{children:"from"})," address to all zeros, if you want to avoid annoying signature popups in\nthe user's wallet for calls that do not need to be signed. The JS library will\ndo this for you."]}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsx)(t.p,{children:"Inside the smart contract code, there is no way of knowing whether the\nclient's call data were originally encrypted or not."})}),"\n",(0,s.jsxs)(o,{children:[(0,s.jsx)("summary",{children:"Detailed confidential smart contract transaction flow on Sapphire"}),(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Diagram of the detailed confidential smart contract transaction flow on Sapphire",src:n(7082).A+"",width:"1087",height:"4156"})})]}),"\n",(0,s.jsxs)(o,{children:[(0,s.jsx)("summary",{children:"Detailed confidential smart contract call flow on Sapphire"}),(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Diagram of the detailed confidential smart contract call flow on Sapphire",src:n(1682).A+"",width:"1087",height:"3798"})})]}),"\n",(0,s.jsx)(t.h2,{id:"contract-state",children:"Contract State"}),"\n",(0,s.jsxs)(t.p,{children:["The Sapphire state model is like Ethereum's except for all state being encrypted\nand not accessible to anyone except the contract. The contract, executing in an\nactive (attested) Oasis compute node is the only entity that can request its\nstate encryption key from the Oasis key manager. Both the keys and values of the\nitems stored in state are encrypted, but the ",(0,s.jsx)(t.strong,{children:"size of either is not hidden"}),". Your\napp may need to pad state items to a constant length, or use other obfuscation.\nObservers may also be able to infer computation based on storage access patterns,\nso you may need to obfuscate that, too. See ",(0,s.jsx)(t.a,{href:"/build/sapphire/develop/security#storage-access-patterns",children:"Security chapter"})," for more\nrecommendations."]}),"\n",(0,s.jsx)(t.admonition,{title:"Contract state leaks a fine-grained access pattern",type:"danger",children:(0,s.jsx)(t.p,{children:"Contract state is backed by an encrypted key-value store. However, the trace of\nencrypted records is leaked to the compute node. As a concrete example, an ERC-20\ntoken transfer would leak which encrypted record is for the sender's account\nbalance and which is for the receiver's account balance. Such a token would be\ntraceable from sender address to receiver address. Obfuscating the storage access\npatterns may be done by using an ORAM implementation."})}),"\n",(0,s.jsx)(t.p,{children:"Contract state may be made available to third parties through logs/events, or\nexplicit getters."}),"\n",(0,s.jsx)(t.h2,{id:"contract-logs",children:"Contract Logs"}),"\n",(0,s.jsxs)(t.p,{children:["Contract logs/events (e.g., those emitted by the Solidity ",(0,s.jsx)(t.code,{children:"emit"})," keyword)\nare exactly like Ethereum. Data contained in events is ",(0,s.jsx)(t.em,{children:"not"})," encrypted.\nPrecompiled contracts are available to help you encrypt data that you can\nthen pack into an event, however."]}),"\n",(0,s.jsx)(t.admonition,{title:"Unmodified contracts may leak state through logs",type:"danger",children:(0,s.jsxs)(t.p,{children:["Base contracts like those provided by OpenZeppelin often emit logs containing\nprivate information. If you don't know they're doing that, you might undermine\nthe confidentiality of your state. As a concrete example, the ERC-20 spec\nrequires implementers to emit an ",(0,s.jsx)(t.code,{children:"event Transfer(from, to, amount)"}),", which is\nobviously problematic if you're writing a confidential token. What you can\ndo instead is fork that contract and remove the offending emissions."]})}),"\n",(0,s.jsx)(t.h2,{id:"see-also",children:"See also"}),"\n",(0,s.jsx)(r.A,{item:(0,i.$)("/build/sapphire/ethereum")})]})}function u(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},4405:(e,t,n)=>{n.d(t,{A:()=>g});n(6540);var o=n(4164),s=n(6289),a=n(3751),r=n(1430),i=n(2887),c=n(539),l=n(9303);const d={cardContainer:"cardContainer_fWXF",cardTitle:"cardTitle_rnsV",cardDescription:"cardDescription_PWke"};var h=n(4848);function p(e){let{href:t,children:n}=e;return(0,h.jsx)(s.A,{href:t,className:(0,o.A)("card padding--lg",d.cardContainer),children:n})}function u(e){let{href:t,icon:n,title:s,description:a}=e;return(0,h.jsxs)(p,{href:t,children:[(0,h.jsxs)(l.A,{as:"h2",className:(0,o.A)("text--truncate",d.cardTitle),title:s,children:[n," ",s]}),a&&(0,h.jsx)("p",{className:(0,o.A)("text--truncate",d.cardDescription),title:a,children:a})]})}function m(e){let{item:t}=e;const n=(0,a.Nr)(t),o=function(){const{selectMessage:e}=(0,r.W)();return t=>e(t,(0,c.T)({message:"1 item|{count} items",id:"theme.docs.DocCard.categoryDescription.plurals",description:"The default description for a category card in the generated index about how many items this category includes"},{count:t}))}();return n?(0,h.jsx)(u,{href:n,icon:"\ud83d\uddc3\ufe0f",title:t.label,description:t.description??o(t.items.length)}):null}function f(e){let{item:t}=e;const n=(0,i.A)(t.href)?"\ud83d\udcc4\ufe0f":"\ud83d\udd17",o=(0,a.cC)(t.docId??void 0);return(0,h.jsx)(u,{href:t.href,icon:n,title:t.label,description:t.description??o?.description})}function g(e){let{item:t}=e;switch(t.type){case"link":return(0,h.jsx)(f,{item:t});case"category":return(0,h.jsx)(m,{item:t});default:throw new Error(`unknown item type ${JSON.stringify(t)}`)}}},1430:(e,t,n)=>{n.d(t,{W:()=>l});var o=n(6540),s=n(797);const a=["zero","one","two","few","many","other"];function r(e){return a.filter((t=>e.includes(t)))}const i={locale:"en",pluralForms:r(["one","other"]),select:e=>1===e?"one":"other"};function c(){const{i18n:{currentLocale:e}}=(0,s.A)();return(0,o.useMemo)((()=>{try{return function(e){const t=new Intl.PluralRules(e);return{locale:e,pluralForms:r(t.resolvedOptions().pluralCategories),select:e=>t.select(e)}}(e)}catch(t){return console.error(`Failed to use Intl.PluralRules for locale "${e}".\nDocusaurus will fallback to the default (English) implementation.\nError: ${t.message}\n`),i}}),[e])}function l(){const e=c();return{selectMessage:(t,n)=>function(e,t,n){const o=e.split("|");if(1===o.length)return o[0];o.length>n.pluralForms.length&&console.error(`For locale=${n.locale}, a maximum of ${n.pluralForms.length} plural forms are expected (${n.pluralForms.join(",")}), but the message contains ${o.length}: ${e}`);const s=n.select(t),a=n.pluralForms.indexOf(s);return o[Math.min(a,o.length-1)]}(n,t,e)}}},4117:(e,t,n)=>{n.d(t,{$:()=>r});var o=n(1858),s=n(797);function a(e){for(const t of e){const e=t.href;e&&void 0===globalThis.sidebarItemsMap[e]&&(globalThis.sidebarItemsMap[e]=t),"category"===t.type&&a(t.items)}}function r(e){const{siteConfig:t,siteMetadata:n}=(0,s.A)(),r=(0,o.r)();if(!r)throw new Error("Unexpected: cant find docsVersion in current context");if(void 0===globalThis.sidebarItemsMap){globalThis.sidebarItemsMap={};for(const e in r.docsSidebars)a(r.docsSidebars[e])}if(void 0===globalThis.sidebarItemsMap[e]){if(console.log(`Item ${e} not found. Registered sidebar items:`),console.log(globalThis.sidebarItemsMap),"throw"==t.onBrokenMarkdownLinks)throw new Error(`Unexpected: sidebar item with href ${e} does not exist.`);return globalThis.sidebarItemsMap["/general/"]}return globalThis.sidebarItemsMap[e]}},1682:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/c10l-smart-contract-call.mmd-1b2ea1dacc2671195dd0724dee7c77d3.svg"},7082:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/c10l-smart-contract-tx.mmd-b6fc78c28b4c720fa84c91c2f355d0e9.svg"},695:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/client-km-compute-a307547826b06e75b807854f9ed1fa17.svg"},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>i});var o=n(6540);const s={},a=o.createContext(s);function r(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);