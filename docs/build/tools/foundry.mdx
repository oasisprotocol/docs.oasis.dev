---
description: A guide for Foundry
---

# Foundry

## Intro

[Foundry] is a smart contract development environment 
for EVM based chains. This guide will show you how to use Foundry to build, 
test, and deploy smart contracts on the Sapphire Network.


:::info

For comprehensive details about Foundry's features, consult the
[Foundry documentation].

:::

## Foundry Toolset

Foundry contains a collection of tools that help you build, test, and deploy 
smart contracts on EVM based chains.

**Forge** is a CLI [tool](https://book.getfoundry.sh/forge/) for building, testing, and deploying smart contracts. 
Due to integrated revm it significantly increases runtime speed when testing. 

**Anvil** is a local development EVM [node](https://book.getfoundry.sh/anvil/). 
It is installed as part of Foundry, but currently does not work with Sapphire.

**Cast** is a CLI [tool](https://book.getfoundry.sh/cast/) for interacting with EVM nodes. As it uses RPC calls it can be used
to interact with Sapphire localnet/testnet nodes.

**Chisel** is Solidity [REPL](https://book.getfoundry.sh/chisel/). Not tested with Sapphire contracts, so use at your own risk.


## Setup and Configuration

Foundry uses default revm EVM implementation which does not contain 
all the [features](https://docs.oasis.io/build/sapphire/ethereum) of Sapphire.
For that reason, we have to install special Sapphire precompiles which are 
available in the Sapphire foundry integration package. 
Steps 3-7 are required only for running tests with Forge.

1. Install and run Foundryup:
   ```bash
   curl -L https://foundry.paradigm.xyz | bash
   foundryup
   source ~/.bashrc
   ```
2. Create a new Forge project and move inside:
   ```bash
   forge init sapphire_demo
   cd sapphire_demo
   ```
3. Install Sapphire contracts:
   ```bash
   forge soldeer install @oasisprotocol-sapphire-contracts~0.2.11 --config-location foundry
   ```
4. Install Sapphire foundry package:
   ```bash
   forge soldeer install @oasisprotocol-integrations-foundry~0.1.1 --config-location foundry
   ```
5. Install rust nightly:
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   rustup toolchain install nightly
   rustup default nightly
   ```
6. Install Sapphire precompiles:
   ```bash
   cd dependencies/@oasisprotocol-integrations-foundry/precompiles
   cargo +nightly build --release
   ```
7. Enable ffi (foreign function interface) in foundry.toml:
   ```bash
   ffi = true
   ```

## Sapphire specific features

For users that aren't familiar with confidential benefits of Sapphire, 
take a second to review the Ethereum [comparison page](https://docs.oasis.io/build/sapphire/ethereum).
`@oasisprotocol-integrations-foundry` package enables 
testing precompile and encrypted calls.

#### Precompiles

Sapphire precompiles are special precompiled contracts that 
contain cryptographic primitives and enable confidential transactions.
Since Foundry uses un-customized revm, they are not available by default.

To enable them in Forge tests, add the **import** statement to your test file:

```solidity
import "@oasisprotocol-sapphire-contracts-0.2.11/BaseSapphireTest.sol";;
```
and then inherit from `SapphireTest` from `BaseSapphireTest.sol` 
and override `setUp()` function:
```solidity
   contract PrecompileTest is SapphireTest {
      
      function setUp() public override {
         super.setUp();
      }
```

#### Encrypted Transactions and Calls

Sapphire uses end-to-end encryption for confidential transactions and calls.
This means that the calldata is encrypted using the shared [key](https://docs.oasis.io/build/sapphire/develop/concept).
For non-encrypted transactions, the process works same as on Ethereum.
However, when testing [gasless transactions](https://docs.oasis.io/build/sapphire/develop/gasless) with Foundry,
we need to add a few things.

After deploying the precompiles in the previous step, we need to 
update our custom contract, encrypt the transaction and broadcast it.

1. `SapphireDecryptor` is a special contract that implements decryption through the fallback function.
We need to inherit from it to enable decryption.
```solidity
   import {SapphireDecryptor} from "@oasisprotocol-sapphire-contracts-0.2.11/BinaryContracts.sol";

   contract CustomContract is SapphireDecryptor {
```
2. See examples/foundry for this step to generate signed gasless tx.
3. `vm.broadcastRawTransaction(raw_tx)` to send the raw transaction.


### Forge Tests

To run tests add a new file in the tests/ directory. Run tests with:
```bash
forge test
```
Some example can be found in the examples/foundry directory.

### Forge Script

To run a script add a new file in the scripts/ directory. Run scripts with:
```bash
forge script
```
Forge scripts should run the same way as tests.

# A note on Forks/External RPC nodes

When running scripts, we might also want to run on localnet/testnet/mainnet using --rpc-url or --fork-url.
This is not possible with this setup, because Sapphire precompiles are not available in the default revm.
When using forge script on a external RPC node or a fork, precompiles are available through vm.rpcUrl() cheatcode.
To disable simulation on integrated revm make sure to disable simulation with --no-simulation flag and 
remove the imports and inheritances from previous steps.


[Quickstart Tutorial]: https://github.com/oasisprotocol/docs/blob/main/docs/build/sapphire/quickstart.mdx

Should you have any questions, do not hesitate to share them with us on the
[#dev-central Discord channel][discord].

[Foundry]: https://github.com/foundry-rs/foundry
[Foundry documentation]: https://book.getfoundry.sh/
[discord]: https://oasis.io/discord
